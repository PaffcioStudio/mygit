#!/usr/bin/env bash

# =============================================================================
# üß† mygit-local - Lokalny system wersjonowania
# Globalny wrapper dla narzƒôdzia mygit (pe≈Çna wersja lokalna)
# =============================================================================

# Sta≈Ça ≈õcie≈ºka do projektu mygit (dostosuj do swojej ≈õcie≈ºki)
MYGIT_DIR="/home/paffcio/Pobrane/mygit"
CLI="${MYGIT_DIR}/cli/index.js"

# Kolorowe outputy
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

# Funkcja logowania
log_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  mygit-local:${NC} $1"
}

log_success() {
    echo -e "${GREEN}‚úÖ mygit-local:${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  mygit-local:${NC} $1"
}

log_error() {
    echo -e "${RED}‚ùå mygit-local:${NC} $1"
}

log_command() {
    echo -e "${CYAN}üß† mygit-local:${NC} $1"
}

# Sprawd≈∫ czy MYGIT_DIR istnieje
if [ ! -d "$MYGIT_DIR" ]; then
    log_error "Katalog mygit nie istnieje: $MYGIT_DIR"
    log_info "Zmie≈Ñ ≈õcie≈ºkƒô MYGIT_DIR w skrypcie: $(which mygit-local)"
    exit 1
fi

# Sprawd≈∫ czy CLI istnieje
if [ ! -f "$CLI" ]; then
    log_error "Plik CLI nie istnieje: $CLI"
    exit 1
fi

# Sprawd≈∫ czy Node.js jest dostƒôpny
if ! command -v node >/dev/null 2>&1; then
    log_error "Node.js nie jest zainstalowany!"
    exit 1
fi

# Sprawd≈∫ czy zale≈ºno≈õci sƒÖ zainstalowane, je≈õli nie - zainstaluj
if [ ! -d "$MYGIT_DIR/node_modules" ]; then
    log_warning "Zale≈ºno≈õci Node.js nie sƒÖ zainstalowane."
    log_info "Instalowanie zale≈ºno≈õci w: $MYGIT_DIR"
    
    cd "$MYGIT_DIR"
    if npm install; then
        log_success "Zale≈ºno≈õci zosta≈Çy pomy≈õlnie zainstalowane"
    else
        log_error "B≈ÇƒÖd podczas instalacji zale≈ºno≈õci!"
        exit 1
    fi
fi

# Ustaw nazwƒô repozytorium na podstawie bie≈ºƒÖcego katalogu
REPO_NAME=$(basename "$(pwd)")

# Pomoc dla u≈ºytkownika
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    echo -e "${MAGENTA}"
    echo "üß† mygit-local - Lokalny system wersjonowania"
    echo "Globalny wrapper - wersja 1.1.0"
    echo -e "${NC}"
    echo "U≈ºycie:"
    echo "  mygit-local [komenda] [opcje]"
    echo ""
    echo "Podstawowe komendy:"
    echo "  init          - Utw√≥rz repozytorium w bie≈ºƒÖcym folderu"
    echo "  comment [opis]- Zmie≈Ñ opis repozytorium"
    echo "  save [opis]   - Zr√≥b snapshot z opisem"
    echo "  log           - Poka≈º historiƒô snapshot√≥w"
    echo "  status        - Poka≈º status repozytorium"
    echo "  list          - Lista wszystkich repozytori√≥w"
    echo "  delete [plik] - Usu≈Ñ snapshot"
    echo ""
    echo "Dodatkowe opcje:"
    echo "  --server      - Uruchom serwer webowy"
    echo "  --help        - Poka≈º pomoc"
    echo ""
    echo "Przyk≈Çady:"
    echo "  mygit-local init"
    echo "  mygit-local comment \"M√≥j projekt Node.js\""
    echo "  mygit-local save \"Dodano nowƒÖ funkcjƒô\""
    echo "  mygit-local log"
    echo "  mygit-local status"
    exit 0
fi

# Uruchom serwer
if [ "$1" = "--server" ] || [ "$1" = "server" ]; then
    log_info "Uruchamianie serwera webowego..."
    cd "$MYGIT_DIR"
    npm start
    exit 0
fi

# Je≈õli brak argument√≥w, poka≈º pomoc
if [ $# -eq 0 ]; then
    ARGS=("--help")
else
    ARGS=("$@")
fi

# G≈Ç√≥wna komenda
log_command "Wykonywanie komendy: ${ARGS[*]}"
log_info "Repozytorium: $REPO_NAME"
log_info "≈öcie≈ºka: $(pwd)"

REPO_NAME="${REPO_NAME}" node "${CLI}" "${ARGS[@]}"

EXIT_CODE=$?

# Obs≈Çuga kod√≥w wyj≈õcia
if [ $EXIT_CODE -eq 0 ]; then
    log_success "Komenda zako≈Ñczona sukcesem"
else
    log_error "Komenda zako≈Ñczona z kodem b≈Çƒôdu: $EXIT_CODE"
fi

exit $EXIT_CODE