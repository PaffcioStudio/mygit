#!/usr/bin/env bash

# =============================================================================
# üß† mygit - Zdalny system wersjonowania na Synology DSM
# Wrapper przez SSH dla Synology DSM
# =============================================================================

# Sta≈Çe dane logowania (dostosuj do swoich)
SSH_USER="Paffcio"
SSH_HOST="192.168.0.130"
REMOTE_DIR="/volume1/NodeServers/NodeServiceHUB/servers/mygit"
REMOTE_CLI="${REMOTE_DIR}/cli/index.js"
SSH_PASS="aA@512513314"

# Kolorowe outputy
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

# Funkcja logowania
log_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  mygit:${NC} $1" >&2
}

log_success() {
    echo -e "${GREEN}‚úÖ mygit:${NC} $1" >&2
}

log_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  mygit:${NC} $1" >&2
}

log_error() {
    echo -e "${RED}‚ùå mygit:${NC} $1" >&2
}

log_command() {
    echo -e "${CYAN}üß† mygit:${NC} $1" >&2
}

# Funkcja do tworzenia listy plik√≥w do uwzglƒôdnienia
create_file_list() {
    local file_list="/tmp/mygit_files_$$.txt"
    
    # U≈ºyj find aby znale≈∫ƒá wszystkie pliki, ale pomi≈Ñ te wykluczone
    local exclude_dirs=(".git" "node_modules" ".DS_Store" ".mygitignore")
    
    # Dodaj wzorce z .mygitignore je≈õli istnieje
    if [ -f ".mygitignore" ]; then
        log_info "Uwzglƒôdniono plik .mygitignore"
        while IFS= read -r pattern || [ -n "$pattern" ]; do
            # Pomijaj komentarze i puste linie
            pattern=$(echo "$pattern" | sed 's/#.*$//' | tr -d '[:space:]')
            if [ -n "$pattern" ]; then
                # Usu≈Ñ ko≈Ñcowy / je≈õli istnieje
                pattern="${pattern%/}"
                exclude_dirs+=("$pattern")
            fi
        done < ".mygitignore"
    fi
    
    # Zbuduj polecenie find z wykluczeniami
    local find_cmd="find . -type f"
    for dir in "${exclude_dirs[@]}"; do
        find_cmd="$find_cmd -not -path \"./$dir/*\" -not -name \"$dir\""
    done
    
    # Wykonaj find i zapisz do pliku
    eval $find_cmd > "$file_list"
    
    echo "$file_list"
}

# Pomoc dla u≈ºytkownika
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    echo -e "${MAGENTA}"
    echo "üß† mygit - Zdalny system wersjonowania na Synology DSM"
    echo "Globalny wrapper - wersja 1.1.0"
    echo -e "${NC}"
    echo "U≈ºycie:"
    echo "  mygit [komenda] [opcje]"
    echo ""
    echo "Podstawowe komendy:"
    echo "  init            - Utw√≥rz repozytorium w bie≈ºƒÖcym folderu"
    echo "  comment [opis]  - Zmie≈Ñ opis repozytorium"
    echo "  save [opis]     - Zr√≥b snapshot z opisem"
    echo "  log             - Poka≈º historiƒô snapshot√≥w"
    echo "  status          - Poka≈º status repozytorium"
    echo "  list            - Lista wszystkich repozytori√≥w"
    echo "  delete [plik]   - Usu≈Ñ snapshot"
    echo ""
    echo "Przyk≈Çady:"
    echo "  mygit init"
    echo "  mygit comment \"M√≥j projekt Node.js\""
    echo "  mygit save \"Dodano nowƒÖ funkcjƒô\""
    echo "  mygit log"
    echo "  mygit status"
    exit 0
fi

# Sprawd≈∫ czy sshpass jest dostƒôpny
if ! command -v sshpass >/dev/null 2>&1; then
    log_error "sshpass nie jest zainstalowany. Zainstaluj: sudo apt install sshpass"
    exit 1
fi

# nazwa bie≈ºƒÖcego folderu (repo)
REPO_NAME=$(basename "$(pwd)")

# Je≈õli nie podano argument√≥w ‚Äì poka≈º pomoc
if [ $# -eq 0 ]; then
    ARGS="--help"
else
    ARGS="$*"
fi

# G≈Ç√≥wna komenda
log_command "Wysy≈Çanie komendy do Synology DSM..."
log_info "Repozytorium: $REPO_NAME"
log_info "Lokalna ≈õcie≈ºka: $(pwd)"

# Dla komendy 'save' przesy≈Çamy pliki przez pipe tar
if [ "$1" = "save" ] || [ "$1" = "push" ]; then
    log_info "Przygotowywanie do wys≈Çania snapshotu..."
    
    # Utw√≥rz listƒô plik√≥w do uwzglƒôdnienia
    FILE_LIST=$(create_file_list)
    FILE_COUNT=$(wc -l < "$FILE_LIST")
    log_info "Znaleziono $FILE_COUNT plik√≥w do wys≈Çania"
    
    if [ "$FILE_COUNT" -eq 0 ]; then
        log_error "Brak plik√≥w do wys≈Çania!"
        rm -f "$FILE_LIST"
        exit 1
    fi
    
    log_info "Wysy≈Çanie plik√≥w na Synology (przez pipe tar)..."
    
    # Przesy≈Çamy pliki przez tar pipe z listƒÖ plik√≥w do uwzglƒôdnienia
    if ! tar -cz -T "$FILE_LIST" 2>/dev/null | 
        sshpass -p "$SSH_PASS" ssh -o LogLevel=ERROR -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            "${SSH_USER}@${SSH_HOST}" "
            # Utw√≥rz tymczasowy katalog
            TEMP_DIR=\"/tmp/mygit_temp_\$\$\"
            mkdir -p \"\$TEMP_DIR\"
            
            # Rozpakuj przychodzƒÖce dane tar
            cd \"\$TEMP_DIR\" && tar -xzf -
            
            # Wykonaj komendƒô mygit
            cd '${REMOTE_DIR}'
            REPO_NAME='${REPO_NAME}' SOURCE_PATH=\"\$TEMP_DIR\" /usr/local/bin/node '${REMOTE_CLI}' ${ARGS}
            
            # PosprzƒÖtaj
            rm -rf \"\$TEMP_DIR\"
            "; then
        log_error "B≈ÇƒÖd podczas przesy≈Çania lub wykonywania komendy na Synology!"
        rm -f "$FILE_LIST"
        exit 1
    fi
    
    # Usu≈Ñ listƒô plik√≥w
    rm -f "$FILE_LIST"
    
else
    # Dla innych komend (init, comment, log, status, list) - normalne wykonanie
    if ! sshpass -p "$SSH_PASS" ssh -o LogLevel=ERROR -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
        "${SSH_USER}@${SSH_HOST}" "cd '${REMOTE_DIR}' && REPO_NAME='${REPO_NAME}' /usr/local/bin/node '${REMOTE_CLI}' ${ARGS}"; then
        log_error "B≈ÇƒÖd podczas wykonywania komendy na Synology!"
        exit 1
    fi
fi

EXIT_CODE=$?

# Obs≈Çuga kod√≥w wyj≈õcia
if [ $EXIT_CODE -eq 0 ]; then
    log_success "Komenda zako≈Ñczona sukcesem"
else
    log_error "Komenda zako≈Ñczona z kodem b≈Çƒôdu: $EXIT_CODE"
fi

exit $EXIT_CODE