#!/usr/bin/env bash

# =============================================================================
# ðŸ§  mygit - Zdalny system wersjonowania na Synology DSM
# Wrapper przez SSH dla Synology DSM
# =============================================================================

# Dane logowania (skonfigurowane podczas instalacji)
SSH_USER="paffcio"
SSH_HOST="192.168.0.198"
SSH_PORT="22"
REMOTE_DIR="/home/paffcio/NodeServers/NodeServiceHUB/servers/mygit"
REMOTE_CLI="${REMOTE_DIR}/cli/index.js"
SSH_PASS="logiNN"
BACKEND_URL="http://192.168.0.198:3350"
REMOTE_NODE_PATH="/usr/bin/node"

# Kolorowe outputy
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

# Funkcja logowania
log_info() {
    echo -e "${BLUE}â„¹ï¸  mygit:${NC} $1" >&2
}

log_success() {
    echo -e "${GREEN}âœ… mygit:${NC} $1" >&2
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  mygit:${NC} $1" >&2
}

log_error() {
    echo -e "${RED}âŒ mygit:${NC} $1" >&2
}

log_command() {
    echo -e "${CYAN}ðŸ§  mygit:${NC} $1" >&2
}

# Pomoc dla uÅ¼ytkownika
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    echo -e "${MAGENTA}"
    echo "ðŸ§  mygit - Zdalny system wersjonowania na Synology DSM"
    echo "Globalny wrapper - wersja 1.2.0"
    echo -e "${NC}"
    echo "UÅ¼ycie:"
    echo "  mygit [komenda] [opcje]"
    echo ""
    echo "Podstawowe komendy:"
    echo "  init                  - UtwÃ³rz repozytorium w bieÅ¼Ä…cym folderu"
    echo "  comment [opis]        - ZmieÅ„ opis repozytorium"
    echo "  save [opis]           - ZrÃ³b snapshot z opisem"
    echo "  log                   - PokaÅ¼ historiÄ™ snapshotÃ³w"
    echo "  status                - PokaÅ¼ status repozytorium"
    echo "  list                  - Lista wszystkich repozytoriÃ³w"
    echo "  delete [plik]         - UsuÅ„ snapshot"
    echo "  get [repo[@snapshot]] - Pobierz snapshot (najnowszy lub konkretny)"
    echo ""
    echo "Opcje dla get:"
    echo "  -f, --force          Nadpisz istniejÄ…ce pliki"
    echo "  -b, --backup         ZrÃ³b backup przed nadpisaniem (domyÅ›lnie: tak)"
    echo "  -d, --dry-run        Tylko pokaÅ¼ co by zostaÅ‚o zrobione"
    echo "  -o, --output DIR     Folder docelowy (domyÅ›lnie .)"
    echo "  -s, --skip-conflicts PomiÅ„ pliki gdzie lokalne sÄ… nowsze"
    echo "  -t, --timeout SEC    Timeout pobierania (domyÅ›lnie: 60s)"
    echo ""
    echo "PrzykÅ‚ady get:"
    echo "  mygit get                                    # Pobierz najnowszy snapshot bieÅ¼Ä…cego repo"
    echo "  mygit get myproject                          # Pobierz najnowszy snapshot myproject"
    echo "  mygit get myproject@2025-12-04_15-30-00.zip  # Pobierz konkretny snapshot"
    echo "  mygit get myproject --force                  # Nadpisz wszystkie pliki"
    echo "  mygit get --output /backup                   # Pobierz do folderu /backup"
    echo "  mygit get --skip-conflicts                   # PomiÅ„ pliki z konfliktami"
    exit 0
fi

# nazwa bieÅ¼Ä…cego folderu (repo)
REPO_NAME=$(basename "$(pwd)")

# JeÅ›li nie podano argumentÃ³w â€“ pokaÅ¼ pomoc
if [ $# -eq 0 ]; then
    ARGS="--help"
else
    ARGS="$*"
fi

# Dla komendy 'save' przesyÅ‚amy pliki przez pipe tar
if [ "$1" = "save" ] || [ "$1" = "push" ]; then
    log_info "Przygotowywanie do wysÅ‚ania snapshotu..."
    
    # UtwÃ³rz tymczasowy katalog
    TEMP_DIR="/tmp/mygit_temp_$$"
    mkdir -p "$TEMP_DIR"
    
    # Skopiuj pliki (pomijajÄ…c node_modules i inne)
    rsync -av --exclude='node_modules' --exclude='.git' --exclude='.DS_Store' --exclude='*.log' . "$TEMP_DIR/" > /dev/null 2>&1
    
    # PrzesyÅ‚amy pliki przez tar pipe
    log_info "WysyÅ‚anie plikÃ³w na Synology..."
    
    if ! tar -czf - -C "$TEMP_DIR" . 2>/dev/null |         sshpass -p "$SSH_PASS" ssh -o LogLevel=ERROR -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p "$SSH_PORT"             "${SSH_USER}@${SSH_HOST}" "
            # UtwÃ³rz tymczasowy katalog
            REMOTE_TEMP=\"/tmp/mygit_remote_$$\"
            mkdir -p \"$REMOTE_TEMP\"
            
            # Rozpakuj przychodzÄ…ce dane tar
            cd \"$REMOTE_TEMP\" && tar -xzf -
            
            # Wykonaj komendÄ™ mygit
            cd '/home/paffcio/NodeServers/NodeServiceHUB/servers/mygit'
            REPO_NAME='${REPO_NAME}' SOURCE_PATH=\"$REMOTE_TEMP\" ${REMOTE_NODE_PATH} '${REMOTE_CLI}' ${ARGS}
            
            # PosprzÄ…taj
            rm -rf \"$REMOTE_TEMP\"
            "; then
        log_error "BÅ‚Ä…d podczas przesyÅ‚ania lub wykonywania komendy na Synology!"
        rm -rf "$TEMP_DIR"
        exit 1
    fi
    
    # PosprzÄ…taj
    rm -rf "$TEMP_DIR"
    
else
    # Dla innych komend - normalne wykonanie
    if ! sshpass -p "$SSH_PASS" ssh -o LogLevel=ERROR -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p "$SSH_PORT"         "${SSH_USER}@${SSH_HOST}" "cd '${REMOTE_DIR}' && REPO_NAME='${REPO_NAME}' ${REMOTE_NODE_PATH} '${REMOTE_CLI}' ${ARGS}"; then
        log_error "BÅ‚Ä…d podczas wykonywania komendy na Synology!"
        exit 1
    fi
fi

EXIT_CODE=$?

# ObsÅ‚uga kodÃ³w wyjÅ›cia
if [ $EXIT_CODE -eq 0 ]; then
    log_success "Komenda zakoÅ„czona sukcesem"
else
    log_error "Komenda zakoÅ„czona z kodem bÅ‚Ä™du: $EXIT_CODE"
fi

exit $EXIT_CODE
